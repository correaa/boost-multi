#!/bin/bash
# -*-indent-tabs-mode:t;c-basic-offset:4;tab-width:4;autowrap:nil;-*-
# sudo apt install clang++ clang-tidy cmake cppcheck g++ libblas-dev libfftw3-dev libboost-test-dev libboost-timer-dev make
# sudo dnf install clang clang-tidy cppcheck libasan libubsan
# install circle # mkdir -p $HOME/bin && wget https://www.circle-lang.org/linux/build_latest.tgz -P $HOME/tmp/ && tar -zxvf $HOME/tmp/build_latest.tgz --directory $HOME/bin/ && $HOME/bin/circle --version
# install nvc++  # ($ echo 'deb [trusted=yes] https://developer.download.nvidia.com/hpc-sdk/ubuntu/amd64 /' | sudo tee /etc/apt/sources.list.d/nvhpc.list) && sudo apt-get updatesudo apt-get update && sudo apt-get install nvhpc-22-7
#                # sudo yum-config-manager --add-repo https://developer.download.nvidia.com/hpc-sdk/rhel/nvhpc.repo && sudo yum install -y nvhpc-cuda-multi-23.1
CODECOV_TOKEN=999feb5b-a599-4d02-b9c5-46d977247f3a
 
#-DCMAKE_CXX_FLAGS="-fanalyzer" 

 (mkdir -p .build.clang++                   && cd .build.clang++                   && CXX=clang++                                                   cmake .. -DCMAKE_BUILD_TYPE=Debug                                                                                                                                                 -DCMAKE_CXX_FLAGS="-Wfatal-errors"                                                                                                                     && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&  ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.nvcc                      && cd .build.nvcc                      && CUDACXX="/usr/local/cuda/bin/nvcc"                            cmake .. -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=1 -DCMAKE_CUDA_ARCHITECTURES=61                                                                                                                                                                                                                                                                                                                                                                                                                              && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.g++-9.sani-check-cov      && cd .build.g++-9.sani-check-cov      && CXX=g++                                                       cmake .. -DCMAKE_BUILD_TYPE=Debug                           -DCMAKE_CXX_CPPCHECK="cppcheck;--enable=all;--suppress=missingIncludeSystem;--inline-suppr;--std=c++17;--check-config;--error-exitcode=1" -DCMAKE_CXX_FLAGS="-D_GLIBCXX_DEBUG=1                   -Wfatal-errors -fsanitize=address,undefined,pointer-compare,pointer-subtract,float-divide-by-zero -fno-sanitize-recover=all --coverage -fno-inline -fno-inline-small-functions -fno-default-inline" -DCMAKE_EXE_LINKER_FLAGS="-lgcov --coverage" && (make -j $(($(nproc) + 2)) || make VERBOSE=1) && ASAN_OPTIONS="new_delete_type_mismatch=0" ctest -j 12 --output-on-failure -T Test) || exit 666
 (mkdir -p .build.clang++.sani-tidy         && cd .build.clang++.sani-tidy         && CXX=clang++                                                   cmake .. -DCMAKE_BUILD_TYPE=Debug                           -DCMAKE_CXX_CLANG_TIDY="clang-tidy"                                                                                                       -DCMAKE_CXX_FLAGS="-D_GLIBCXX_DEBUG=1 -D_LIBCPP_DEBUG=1 -Wfatal-errors -fsanitize=address,undefined,pointer-compare,pointer-subtract,float-divide-by-zero -fno-sanitize-recover=all"                                                                                                                     && (make -j $(($(nproc) + 2)) || make VERBOSE=1) && ASAN_OPTIONS="new_delete_type_mismatch=0" ctest -j 12 --output-on-failure) || exit 666
#(mkdir -p .build.clang++-13.std20-lint     && cd .build.clang++-13.std20-lint     && CXX=clang++                                                   cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=20 -DCMAKE_CXX_CPPLINT="cpplint;--quiet"                                                                                                                                                                                                                                                                                                                                                                                                              && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.circle                    && cd .build.circle                    && CXX="$HOME/bin/circle"                                        cmake .. -DCMAKE_BUILD_TYPE=Debug   -DENABLE_CIRCLE=1 -DCMAKE_CXX_FLAGS="-nostdinc -I/usr/include/c++/12 -I/usr/include/x86_64-linux-gnu/c++/12 -I/usr/lib/gcc/x86_64-linux-gnu/12/include -I/usr/lib/gcc/x86_64-linux-gnu/12/include -I/usr/include/c++/12/x86_64-redhat-linux -I/usr/lib/gcc/x86_64-redhat-linux/12/include" `#-DBoost_USE_STATIC_LIBS=OFF -DBOOST_LIBRARYDIR=/usr/lib/x86_64-linux-gnu/`  -DBOOST_LIBRARYDIR=/usr/lib64                                                                                                                                                                                                                             && make VERBOSE=1        && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
#(mkdir -p .build.icpc                      && cd .build.icpc                      && CXX=/home/correaa/intel/oneapi/compiler/latest/linux/bin/intel64/icpc                                                                               cmake .. -DCMAKE_BUILD_TYPE=Release                                                                                                                                                                                                                                                                                                                                                                                      && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.icpx                      && cd .build.icpx                      && CXX=/opt/intel/oneapi/compiler/latest/linux/bin/icpx          cmake .. -DCMAKE_BUILD_TYPE=Release                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.nvc++                     && cd .build.nvc++                     && CXX=/opt/nvidia/hpc_sdk/Linux_x86_64/2023/compilers/bin/nvc++ cmake .. -DCMAKE_BUILD_TYPE=Debug                                                                                                                                                                                                                                                                                                                                                                                                                                                                              && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure) || exit 666
 (mkdir -p .build.g++-12.anlys-std20-memchk && cd .build.g++-12.anlys-std20-memchk && CXX=g++                                                       cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=20                  `#-DCMAKE_CXX_INCLUDE_WHAT_YOU_USE="iwyu"` -DCMAKE_CXX_FLAGS="-fanalyzer -Wno-analyzer-null-dereference -Wno-analyzer-possible-null-dereference -Wno-analyzer-malloc-leak -Wno-analyzer-use-of-uninitialized-value -Wno-analyzer-use-after-free"                                                                                                                                                                                     && (make -j $(($(nproc) + 2)) || make VERBOSE=1) &&                                           ctest -j 12 --output-on-failure --overwrite MemoryCheckCommandOptions="-q --tool=memcheck --leak-check=yes --num-callers=51 --trace-children=yes --leak-check=full --track-origins=yes --gen-suppressions=all" -T memcheck) || exit 666

#(mkdir -p .build.clang++.iwyu && cd .build.clang++.iwyu && CXX=clang++                     cmake .. -DCMAKE_CXX_INCLUDE_WHAT_YOU_USE="iwyu" && make -j 10 && ctest -j 12 --output-on-failure) || exit
#(find . -name '*.hpp' -exec cppcheck --enable=all --inline-suppr --suppress=unmatchedSuppression:{} --suppress=syntaxError --suppress=missingInclude --suppress=missingIncludeSystem --suppress=preprocessorErrorDirective --suppress=syntaxError --suppress=unusedFunction --suppress=arithOperationsOnVoidPointer --suppress=sizeofDereferencedVoidPointer -D__align__ -DCUDARTAPI --language=c++ --std=c++17 --error-exitcode=666 --suppress=unmatchedSuppression {} \;) || exit
